<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OIFITS Simulator: vis_sim/oifits_sim.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_72ef693a9b20303b80390e494a4910ad.html">vis_sim</a>
  </div>
</div>
<div class="contents">
<h1>oifits_sim.cpp</h1><a href="oifits__sim_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * simulator.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  Created on: 21 Jul 2009</span>
<a name="l00005"></a>00005 <span class="comment"> *      Author: Andra Stroe</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="comment">// Include built-in libraries</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="oifits__sim_8h.html">oifits_sim.h</a>&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="comment">// Header files for other libraries</span>
<a name="l00017"></a>00017 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00018"></a>00018 <span class="preprocessor">    #include &quot;exchange.h&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">    #include &quot;oifile.h&quot;</span>
<a name="l00020"></a>00020 }
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="comment">// Header files for remaining classes.</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="Array_8h.html">Array.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="Baseline_8h.html">Baseline.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="Bispectrum_8h.html">Bispectrum.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="Instrument_8h.html">Instrument.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="NoiseModel_8h.html">NoiseModel.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="PowerSpectrum_8h.html">PowerSpectrum.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="random_8h.html">random.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="Simulator_8h.html">Simulator.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="Source_8h.html">Source.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="SpectralMode_8h.html">SpectralMode.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="UVPoint_8h.html">UVPoint.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="VisSimParams_8h.html">VisSimParams.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="Observation_8h.html">Observation.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">using</span> std::cout;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">// function that computes power spectra from the complex visibilities</span>
<a name="l00041"></a><a class="code" href="oifits__sim_8cpp.html#a9c99622adbe6cfcb37111a50422826e3">00041</a> <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a> <a class="code" href="oifits__sim_8cpp.html#a9c99622adbe6cfcb37111a50422826e3">Vis2Pow</a>(<a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> &amp;visibility, <span class="keywordtype">int</span> Nwav, <span class="keywordtype">int</span> Npow)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>pow(Nwav, Npow);
<a name="l00044"></a>00044 
<a name="l00045"></a>00045         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; Nwav; i++)
<a name="l00046"></a>00046         {
<a name="l00047"></a>00047                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; Npow; j++)
<a name="l00048"></a>00048                 {                                               <span class="comment">// power spectrum as the</span>
<a name="l00049"></a>00049                         <span class="comment">// norm of the visibility</span>
<a name="l00050"></a>00050                         pow[i][j] = norm(visibility[i][j]);
<a name="l00051"></a>00051                 }
<a name="l00052"></a>00052         }
<a name="l00053"></a>00053         <span class="keywordflow">return</span> (pow);
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">// function that computes bispectra from the complex visibilities</span>
<a name="l00057"></a>00057 <span class="comment">// the values depend on: the visibility, the number of telescopes, the</span>
<a name="l00058"></a>00058 <span class="comment">// number of</span>
<a name="l00059"></a>00059 <span class="comment">// wavelengths, the number of bispectra and the number of hour angles</span>
<a name="l00060"></a><a class="code" href="oifits__sim_8cpp.html#ae964626ec80ff322718c79dbbf0e843e">00060</a> <a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> <a class="code" href="oifits__sim_8cpp.html#ae964626ec80ff322718c79dbbf0e843e">Vis2Bis</a>(<a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> &amp;visibility, <span class="keywordtype">int</span> N, <span class="keywordtype">int</span> Nwav, <span class="keywordtype">int</span> Nbs, <span class="keywordtype">int</span> Nha)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062         <span class="keywordtype">int</span> i = 0;                                      <span class="comment">// just a counter</span>
<a name="l00063"></a>00063         <span class="comment">// declaring the bispectrum under the variable name bis; it is a</span>
<a name="l00064"></a>00064         <span class="comment">// complex matrix</span>
<a name="l00065"></a>00065         <a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> bis(Nwav, Nbs);
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; Nwav; ii++)
<a name="l00068"></a>00068         {
<a name="l00069"></a>00069                 i = 0;
<a name="l00070"></a>00070                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj = 0; jj &lt; Nha; jj++)
<a name="l00071"></a>00071                 {
<a name="l00072"></a>00072                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; N - 2; j++)
<a name="l00073"></a>00073                         {
<a name="l00074"></a>00074                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = j + 1; k &lt; N - 1; k++)
<a name="l00075"></a>00075                                 {
<a name="l00076"></a>00076                                         bis[ii][i] = visibility[ii][j + jj * N * (N - 1) / 2]
<a name="l00077"></a>00077                                            * conj(visibility[ii][k + jj * N * (N - 1) / 2])
<a name="l00078"></a>00078                                            * visibility[ii][i + (N - 1) * (jj + 1)];
<a name="l00079"></a>00079                                         i++;
<a name="l00080"></a>00080                                 }
<a name="l00081"></a>00081                         }
<a name="l00082"></a>00082                 }
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084         <span class="keywordflow">return</span> (bis);
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">// function computing the noisy power spectra</span>
<a name="l00088"></a>00088 <span class="comment">// the values depend on a series of parameters: the wavelengths, the</span>
<a name="l00089"></a>00089 <span class="comment">// visibility,</span>
<a name="l00090"></a>00090 <span class="comment">// the target, the array, the instrument, the incoherent integration time,</span>
<a name="l00091"></a>00091 <span class="comment">// the number of power spectra, the</span>
<a name="l00092"></a>00092 <span class="comment">// telescope indexes defining the baselines and the u and v coordinates of</span>
<a name="l00093"></a>00093 <span class="comment">// the baselines</span>
<a name="l00094"></a><a class="code" href="oifits__sim_8cpp.html#aa1122d0991d23b3c6fcc3e4ad8d7ce3e">00094</a> <a class="code" href="classPowerSpectrum.html" title="PowerSpectrum class.">PowerSpectrum</a> <a class="code" href="oifits__sim_8cpp.html#aa1122d0991d23b3c6fcc3e4ad8d7ce3e">GenPower</a>(<a class="code" href="classSpectralMode.html" title="A class to represent the spectral mode(s) of the instrument.">SpectralMode</a> &amp; spec, <a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> &amp;visibility,
<a name="l00095"></a>00095    <a class="code" href="classSource.html" title="A class to represent the source object.">Source</a> &amp; target, <a class="code" href="classObservation.html">Observation</a> &amp; obs, <a class="code" href="classInstrument.html">Instrument</a> &amp; inst, <span class="keywordtype">int</span> Npow,
<a name="l00096"></a>00096    <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>&amp;t1, <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>&amp;t2, <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>&amp;u,
<a name="l00097"></a>00097    <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>&amp;v)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099         <a class="code" href="classPowerSpectrum.html" title="PowerSpectrum class.">PowerSpectrum</a> Power;
<a name="l00100"></a>00100         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>Pow(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Npow);
<a name="l00101"></a>00101         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>Err(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Npow);
<a name="l00102"></a>00102         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>noisyPow(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Npow);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         Pow = <a class="code" href="oifits__sim_8cpp.html#a9c99622adbe6cfcb37111a50422826e3">Vis2Pow</a>(visibility, spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Npow);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>; i++)
<a name="l00107"></a>00107         {
<a name="l00108"></a>00108                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; Npow; j++)
<a name="l00109"></a>00109                 {
<a name="l00110"></a>00110                         Err[i][j] = sqrt(<a class="code" href="NoiseModel_8cpp.html#a3010e5e3d05d0c67e05de91b6c5b8914">VarUnbiasedPow1</a>(Pow[i][j], spec, i, target, obs, inst));
<a name="l00111"></a>00111                         noisyPow[i][j] = Pow[i][j] + Err[i][j] * <a class="code" href="random_8c.html#af9e19241a780193f5cdfc9edb4b80ab8">Rangauss</a>(<a class="code" href="oifits__sim_8h.html#af35d1eaf3cd9db9ee8241d511d791af2">random_seed</a>);
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113         }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         <span class="comment">// assigning the values to different members of the class</span>
<a name="l00116"></a>00116         <span class="comment">// PowerSpectrum</span>
<a name="l00117"></a>00117         <span class="comment">// for the object Power</span>
<a name="l00118"></a>00118         Power.<a class="code" href="classPowerSpectrum.html#a20298a01053cfb3aa197d4bc57526bff">pow</a> = <a class="code" href="oifits__sim_8cpp.html#a9c99622adbe6cfcb37111a50422826e3">Vis2Pow</a>(visibility, spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Npow);
<a name="l00119"></a>00119         Power.<a class="code" href="classPowerSpectrum.html#a68e8c6a4fa15893a796f233e35b9886a">vis2err</a> = Err;
<a name="l00120"></a>00120         Power.<a class="code" href="classPowerSpectrum.html#a98e7a9d427be82f83bc9e925d8a44d71">vis2data</a> = noisyPow;
<a name="l00121"></a>00121         Power.<a class="code" href="classPowerSpectrum.html#a42e71945396d45b5603b5ea1f4933a6a">u</a> = u;
<a name="l00122"></a>00122         Power.<a class="code" href="classPowerSpectrum.html#a48e7c06920fc8baaa690a7fcf71284d7">v</a> = v;
<a name="l00123"></a>00123         Power.<a class="code" href="classPowerSpectrum.html#a63136c308d576020a0611fef55e7165b">t1</a> = t1;
<a name="l00124"></a>00124         Power.<a class="code" href="classPowerSpectrum.html#a449e5f435037ff6354d2decaa1345f81">t2</a> = t2;
<a name="l00125"></a>00125         Power.<a class="code" href="classPowerSpectrum.html#a7d07ae6e17c08448bc5ae8a79fc36a95">int_time</a> = inst.<a class="code" href="classInstrument.html#ab431265cc3192bfcc9ceeafd1d30605b">incoh_time</a>;
<a name="l00126"></a>00126         <span class="comment">/*</span>
<a name="l00127"></a>00127 <span class="comment">         * cout &lt;&lt; &quot;POWER SPECTRUM DATA: &quot; &lt;&lt; endl; cout &lt;&lt; &quot;T1 and T2 are: &quot;</span>
<a name="l00128"></a>00128 <span class="comment">         * &lt;&lt; endl &lt;&lt; Power.t1 &lt;&lt; endl &lt;&lt; Power.t2 &lt;&lt; endl; cout &lt;&lt; &quot;u and v</span>
<a name="l00129"></a>00129 <span class="comment">         * are: &quot; &lt;&lt; endl &lt;&lt; Power.u &lt;&lt; endl &lt;&lt; Power.v &lt;&lt; endl; cout &lt;&lt; &quot;The</span>
<a name="l00130"></a>00130 <span class="comment">         * power spectrum is: &quot; &lt;&lt; endl &lt;&lt; Power.pow &lt;&lt; endl; cout &lt;&lt; &quot;The</span>
<a name="l00131"></a>00131 <span class="comment">         * error of the power spectrum is: &quot; &lt;&lt; endl &lt;&lt; Power.vis2err &lt;&lt; endl;</span>
<a name="l00132"></a>00132 <span class="comment">         * cout &lt;&lt; &quot;The power spectrum with error is: &quot; &lt;&lt; endl &lt;&lt;</span>
<a name="l00133"></a>00133 <span class="comment">         * Power.vis2data &lt;&lt; endl; </span>
<a name="l00134"></a>00134 <span class="comment">         */</span>
<a name="l00135"></a>00135         <span class="keywordflow">return</span> (Power);
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">// function that computes the triple amplitude with added noise and the</span>
<a name="l00139"></a>00139 <span class="comment">// closure</span>
<a name="l00140"></a>00140 <span class="comment">// phase with added noise</span>
<a name="l00141"></a>00141 <span class="comment">// the values depend on: the wavelengths, the visibility, the Target, the</span>
<a name="l00142"></a>00142 <span class="comment">// array,</span>
<a name="l00143"></a>00143 <span class="comment">// the instrument, the incoherent integration time,</span>
<a name="l00144"></a>00144 <span class="comment">// the number of triangles and sampled hour angles,</span>
<a name="l00145"></a>00145 <span class="comment">// the telescope indexes and the UV coordinates</span>
<a name="l00146"></a><a class="code" href="oifits__sim_8cpp.html#a71f2cea8183c417db70abae2e7ba130c">00146</a> <a class="code" href="classBispectrum.html">Bispectrum</a> <a class="code" href="oifits__sim_8cpp.html#a71f2cea8183c417db70abae2e7ba130c">GenBispec</a>(<a class="code" href="classSpectralMode.html" title="A class to represent the spectral mode(s) of the instrument.">SpectralMode</a> &amp; spec, <a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> &amp;visibility,
<a name="l00147"></a>00147    <a class="code" href="classSource.html" title="A class to represent the source object.">Source</a> &amp; target, <a class="code" href="classObservation.html">Observation</a> &amp; obs, <a class="code" href="classInstrument.html">Instrument</a> &amp; inst, <span class="keywordtype">int</span> Nbs, <span class="keywordtype">int</span> Nha,
<a name="l00148"></a>00148    <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>&amp;t1, <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>&amp;t2, <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>&amp;u,
<a name="l00149"></a>00149    <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>&amp;v)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151         <a class="code" href="classBispectrum.html">Bispectrum</a> bispec;
<a name="l00152"></a>00152         <span class="keywordtype">int</span> i = 0;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordtype">int</span> nstations = obs.<a class="code" href="classObservation.html#a3c22db814a021723e695db6c8a137e96">GetNumStations</a>();
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="comment">// matrix containing the U coordinate of the 1st baseline of the</span>
<a name="l00157"></a>00157         <span class="comment">// triangle</span>
<a name="l00158"></a>00158         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>u1(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00159"></a>00159         <span class="comment">// matrix containing the V coordinate of the 1st baseline of the</span>
<a name="l00160"></a>00160         <span class="comment">// triangle</span>
<a name="l00161"></a>00161         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>v1(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00162"></a>00162         <span class="comment">// matrix containing the U coordinate of the 2nd baseline of the</span>
<a name="l00163"></a>00163         <span class="comment">// triangle</span>
<a name="l00164"></a>00164         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>u2(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00165"></a>00165         <span class="comment">// matrix containing the V coordinate of the 2nd baseline of the</span>
<a name="l00166"></a>00166         <span class="comment">// triangle</span>
<a name="l00167"></a>00167         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>v2(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00168"></a>00168         <span class="comment">// matrix containing the indexes of the 1st telescope in the triangle</span>
<a name="l00169"></a>00169         <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>tel1(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00170"></a>00170         <span class="comment">// matrix containing the indexes of the 2nd telescope in the triangle</span>
<a name="l00171"></a>00171         <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>tel2(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00172"></a>00172         <span class="comment">// matrix containing the indexes of the 3rd telescope in the triangle</span>
<a name="l00173"></a>00173         <a class="code" href="classMatrix.html">Matrix &lt; int &gt;</a>tel3(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         <span class="comment">// matrix containing the bispectrum</span>
<a name="l00176"></a>00176         <a class="code" href="classMatrix.html">Matrix &lt; Complex &gt;</a> bis(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="comment">// matrix containing the triple amplitude</span>
<a name="l00179"></a>00179         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>T3true(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00180"></a>00180         <span class="comment">// matrix containing the err of the triple amplitude</span>
<a name="l00181"></a>00181         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>ErrT3(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00182"></a>00182         <span class="comment">// matrix containing the triple amplitude with added noise</span>
<a name="l00183"></a>00183         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>T3(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="comment">// matrix containing the closure phase</span>
<a name="l00186"></a>00186         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>Phi(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00187"></a>00187         <span class="comment">// matrix containing the variance of the closure phase</span>
<a name="l00188"></a>00188         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>VarPhi(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00189"></a>00189         <span class="comment">// matrix containing the error of the closure phase</span>
<a name="l00190"></a>00190         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>ErrPhi(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00191"></a>00191         <span class="comment">// matrix containing the closure phase with added noise</span>
<a name="l00192"></a>00192         <a class="code" href="classMatrix.html">Matrix &lt; double &gt;</a>PhiErr(spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         bis = <a class="code" href="oifits__sim_8cpp.html#ae964626ec80ff322718c79dbbf0e843e">Vis2Bis</a>(visibility, nstations, spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>, Nbs, Nha);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="comment">// separate bispectrum into amplitude and phase</span>
<a name="l00197"></a>00197         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>; i++)
<a name="l00198"></a>00198         {
<a name="l00199"></a>00199                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; Nbs; j++)
<a name="l00200"></a>00200                 {
<a name="l00201"></a>00201                         Phi[i][j] = arg(bis[i][j]);
<a name="l00202"></a>00202                         T3true[i][j] = abs(bis[i][j]);
<a name="l00203"></a>00203                 }
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">// add noise</span>
<a name="l00207"></a>00207         VarPhi = <a class="code" href="NoiseModel_8cpp.html#a79488f745855a6fa932f534fe1232e3b" title=": VarCloPhase1() etc.">VarCloPhase</a>(spec, visibility, target, obs, inst, Nbs, Nha);
<a name="l00208"></a>00208         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>; i++)
<a name="l00209"></a>00209         {
<a name="l00210"></a>00210                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; Nbs; j++)
<a name="l00211"></a>00211                 {
<a name="l00212"></a>00212                         ErrPhi[i][j] = sqrt(VarPhi[i][j]);
<a name="l00213"></a>00213                         PhiErr[i][j] = Phi[i][j] + ErrPhi[i][j] * <a class="code" href="random_8c.html#af9e19241a780193f5cdfc9edb4b80ab8">Rangauss</a>(<a class="code" href="oifits__sim_8h.html#af35d1eaf3cd9db9ee8241d511d791af2">random_seed</a>);
<a name="l00214"></a>00214                         <span class="comment">// assume circular noise cloud</span>
<a name="l00215"></a>00215                         ErrT3[i][j] = sqrt(T3true[i][j] * T3true[i][j] * VarPhi[i][j]);
<a name="l00216"></a>00216                         T3[i][j] = T3true[i][j] + ErrT3[i][j] * <a class="code" href="random_8c.html#af9e19241a780193f5cdfc9edb4b80ab8">Rangauss</a>(<a class="code" href="oifits__sim_8h.html#af35d1eaf3cd9db9ee8241d511d791af2">random_seed</a>);
<a name="l00217"></a>00217                 }
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>; ii++)
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222                 i = 0;
<a name="l00223"></a>00223                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj = 0; jj &lt; Nha; jj++)
<a name="l00224"></a>00224                 {
<a name="l00225"></a>00225                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nstations - 2; j++)
<a name="l00226"></a>00226                         {
<a name="l00227"></a>00227                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = j + 1; k &lt; nstations - 1; k++)
<a name="l00228"></a>00228                                 {
<a name="l00229"></a>00229                                         u1[ii][i] =
<a name="l00230"></a>00230                                            u[ii][j + jj * nstations * (nstations - 1) / 2];
<a name="l00231"></a>00231                                         v1[ii][i] =
<a name="l00232"></a>00232                                            v[ii][j + jj * nstations * (nstations - 1) / 2];
<a name="l00233"></a>00233                                         u2[ii][i] = u[ii][i + (jj + 1) * (nstations - 1)];
<a name="l00234"></a>00234                                         v2[ii][i] = v[ii][i + (jj + 1) * (nstations - 1)];
<a name="l00235"></a>00235                                         tel1[ii][i] =
<a name="l00236"></a>00236                                            t1[ii][j + jj * nstations * (nstations -
<a name="l00237"></a>00237                                                   1) / 2];
<a name="l00238"></a>00238                                         tel2[ii][i] =
<a name="l00239"></a>00239                                            t2[ii][j + jj * nstations * (nstations -
<a name="l00240"></a>00240                                                   1) / 2];
<a name="l00241"></a>00241                                         tel3[ii][i] =
<a name="l00242"></a>00242                                            t2[ii][k + jj * nstations * (nstations -
<a name="l00243"></a>00243                                                   1) / 2];
<a name="l00244"></a>00244                                         i++;
<a name="l00245"></a>00245                                 }
<a name="l00246"></a>00246                         }
<a name="l00247"></a>00247                 }
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249         bispec.<a class="code" href="classBispectrum.html#a4aa12f9f42ec6a9a622eae258886a70a">u1</a> = u1;
<a name="l00250"></a>00250         bispec.<a class="code" href="classBispectrum.html#aaaba6a43c24620293150b6c8b1e7e3cc">v1</a> = v1;
<a name="l00251"></a>00251         bispec.<a class="code" href="classBispectrum.html#a1273b649ed0b0395095e46553abd4590">u2</a> = u2;
<a name="l00252"></a>00252         bispec.<a class="code" href="classBispectrum.html#a3f96bf8f14f36a1b554f094e74eea14e">v2</a> = v2;
<a name="l00253"></a>00253         bispec.<a class="code" href="classBispectrum.html#acdc726e2151be0caed4263bfd5945d35">t1</a> = tel1;
<a name="l00254"></a>00254         bispec.<a class="code" href="classBispectrum.html#a0fc19bc4234f4d5f5b5fff0f16a1d19a">t2</a> = tel2;
<a name="l00255"></a>00255         bispec.<a class="code" href="classBispectrum.html#a35a0c8149a0543a004044ff4ffc2eea1">t3</a> = tel3;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         bispec.<a class="code" href="classBispectrum.html#a85904846b909567890fb1395b9fcb27b">trueAmp</a> = T3true;
<a name="l00258"></a>00258         bispec.<a class="code" href="classBispectrum.html#acfb791e23ce2fe5a0d3207d600f5fced">t3amperr</a> = ErrT3;
<a name="l00259"></a>00259         bispec.<a class="code" href="classBispectrum.html#a4f353f039c28e9a954b35efeee88803a">t3amp</a> = T3;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         bispec.<a class="code" href="classBispectrum.html#ac6576cd26a230281ed9471dc18f6c128">truePhi</a> = Phi * (180 / <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a>);
<a name="l00262"></a>00262         bispec.<a class="code" href="classBispectrum.html#acbda066ba007c56246f1a7dc0040e8a4">t3phierr</a> = ErrPhi * (180 / <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a>);
<a name="l00263"></a>00263         bispec.<a class="code" href="classBispectrum.html#afb0c6a5e00123a0816cdaf3f5cf99fb2">t3phi</a> = PhiErr * (180 / <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a>);
<a name="l00264"></a>00264         bispec.<a class="code" href="classBispectrum.html#a1f82b8ea4518fa3870102b1975282c44">int_time</a> = inst.<a class="code" href="classInstrument.html#ab431265cc3192bfcc9ceeafd1d30605b">incoh_time</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="comment">/*</span>
<a name="l00267"></a>00267 <span class="comment">         * cout &lt;&lt; &quot;BISPECTRUM DATA: &quot; &lt;&lt; endl; cout &lt;&lt; &quot;U points and V points </span>
<a name="l00268"></a>00268 <span class="comment">         * are:&quot; &lt;&lt; endl &lt;&lt; bispec.u1 &lt;&lt; endl &lt;&lt; bispec.v1 &lt;&lt; endl; cout &lt;&lt;</span>
<a name="l00269"></a>00269 <span class="comment">         * &quot;Telescope 1 , 2 and 3 are:&quot; &lt;&lt; endl &lt;&lt; bispec.t1 &lt;&lt; endl &lt;&lt;</span>
<a name="l00270"></a>00270 <span class="comment">         * bispec.t2 &lt;&lt; endl &lt;&lt; bispec.t3 &lt;&lt; endl; cout &lt;&lt; &quot;The triple</span>
<a name="l00271"></a>00271 <span class="comment">         * amplitude is: &quot; &lt;&lt; endl &lt;&lt; bispec.t3true &lt;&lt; endl; cout &lt;&lt; &quot;The</span>
<a name="l00272"></a>00272 <span class="comment">         * error of the triple amplitude is: &quot; &lt;&lt; endl &lt;&lt; bispec.t3amperr &lt;&lt;</span>
<a name="l00273"></a>00273 <span class="comment">         * endl; cout &lt;&lt; &quot;The triple amplitude with error is: &quot; &lt;&lt; endl &lt;&lt;</span>
<a name="l00274"></a>00274 <span class="comment">         * bispec.t3amp &lt;&lt; endl;</span>
<a name="l00275"></a>00275 <span class="comment">         * </span>
<a name="l00276"></a>00276 <span class="comment">         * cout &lt;&lt; &quot;The closure phase is: &quot; &lt;&lt; endl &lt;&lt; bispec.phi &lt;&lt; endl;</span>
<a name="l00277"></a>00277 <span class="comment">         * cout &lt;&lt; &quot;The error of the closure phase is: &quot; &lt;&lt; endl &lt;&lt;</span>
<a name="l00278"></a>00278 <span class="comment">         * bispec.t3phierr &lt;&lt; endl; cout &lt;&lt; &quot;The closure phase with error is:</span>
<a name="l00279"></a>00279 <span class="comment">         * &quot; &lt;&lt; endl &lt;&lt; bispec.t3phi &lt;&lt; endl; </span>
<a name="l00280"></a>00280 <span class="comment">         */</span>
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="keywordflow">return</span> (bispec);
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="comment">// AS 2010-06-22</span>
<a name="l00286"></a>00286 <span class="comment">// added function from JSY&#39;s sidereal.c routine to compute the true</span>
<a name="l00287"></a>00287 <span class="comment">// geocentric coordinates </span>
<a name="l00288"></a>00288 <span class="comment">// of the array location</span>
<a name="l00299"></a><a class="code" href="oifits__sim_8cpp.html#abc8d1aa870a53f018b7e1e79a7968041">00299</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="oifits__sim_8cpp.html#abc8d1aa870a53f018b7e1e79a7968041">wgs84_to_geoc</a>(<span class="keywordtype">double</span> lat, <span class="keywordtype">double</span> height, <span class="keywordtype">double</span> *GeocLat, <span class="keywordtype">double</span> *GeocRadius)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301         <span class="keywordtype">double</span> cosLat, sinLat, c, c0, s0, one_f_sq;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         cosLat = cos(lat);
<a name="l00304"></a>00304         sinLat = sin(lat);
<a name="l00305"></a>00305         one_f_sq = (1. - <a class="code" href="oifits__sim_8h.html#a98ba9a3f4405cbe78a674da7efee0df8">WGS_F</a>) * (1. - <a class="code" href="oifits__sim_8h.html#a98ba9a3f4405cbe78a674da7efee0df8">WGS_F</a>);
<a name="l00306"></a>00306         c = pow(cosLat * cosLat + one_f_sq * sinLat * sinLat, -0.5);
<a name="l00307"></a>00307         c0 = <a class="code" href="oifits__sim_8h.html#aac7e3f0ae91a7fa5caed88c6d23dd3f1">WGS_A0</a> * c + height;
<a name="l00308"></a>00308         s0 = <a class="code" href="oifits__sim_8h.html#aac7e3f0ae91a7fa5caed88c6d23dd3f1">WGS_A0</a> * one_f_sq * c + height;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         *GeocLat = atan2(s0 * sinLat, c0 * cosLat);
<a name="l00311"></a>00311         *GeocRadius = pow(c0 * c0 * cosLat * cosLat + s0 * s0 * sinLat * sinLat, 0.5);
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">// AS 2010-06-21 </span>
<a name="l00315"></a>00315 <span class="comment">// Added to avoid crash of the program in case there are only 2 </span>
<a name="l00316"></a>00316 <span class="comment">// telescopes</span>
<a name="l00317"></a>00317 <span class="comment">// AS 2010-06-24</span>
<a name="l00318"></a>00318 <span class="comment">// merged with the other similar function writing the OIFITS file without</span>
<a name="l00319"></a>00319 <span class="comment">// bispectrum</span>
<a name="l00320"></a>00320 <span class="comment">// now working with pointers for bispectrum, rather than objects</span>
<a name="l00321"></a>00321 <span class="comment">// function writing the data obtained into the OIFITS format</span>
<a name="l00322"></a>00322 <span class="comment">// arguments are: the declination of the source, the datafile name, the</span>
<a name="l00323"></a>00323 <span class="comment">// array,</span>
<a name="l00324"></a>00324 <span class="comment">// the wavelengths, the power spectrum, the number of power spectra, the</span>
<a name="l00325"></a>00325 <span class="comment">// bispectrum,</span>
<a name="l00326"></a>00326 <span class="comment">// the number of bispectra and the hour angles (time)</span>
<a name="l00327"></a><a class="code" href="oifits__sim_8cpp.html#af7f7af2a9a20b52d3e4fd0ebc9186039">00327</a> <span class="keywordtype">void</span> <a class="code" href="oifits__sim_8cpp.html#af7f7af2a9a20b52d3e4fd0ebc9186039">write_oifits_file</a>(<span class="keywordtype">float</span> declination, <span class="keywordtype">string</span> datafile, <a class="code" href="classArray.html" title="A class to represent the array (i.e. the interferometer).">Array</a> s,
<a name="l00328"></a>00328    <a class="code" href="classSpectralMode.html" title="A class to represent the spectral mode(s) of the instrument.">SpectralMode</a> spec, <a class="code" href="classPowerSpectrum.html" title="PowerSpectrum class.">PowerSpectrum</a> Power, <span class="keywordtype">int</span> Npow,
<a name="l00329"></a>00329    <a class="code" href="classBispectrum.html">Bispectrum</a> * pBispec, <span class="keywordtype">int</span> Nbs, <a class="code" href="classRow.html">Row &lt; double &gt;</a>time)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         oi_array array;
<a name="l00333"></a>00333         oi_target targets;
<a name="l00334"></a>00334         oi_wavelength wave;
<a name="l00335"></a>00335         oi_vis2 vis2;
<a name="l00336"></a>00336         oi_t3 t3;
<a name="l00337"></a>00337         fitsfile *fptr;
<a name="l00338"></a>00338         <span class="keywordtype">char</span> zerostring[FLEN_VALUE];
<a name="l00339"></a>00339         <span class="keywordtype">char</span> insname[FLEN_VALUE];
<a name="l00340"></a>00340         <span class="keywordtype">char</span> arrname[FLEN_VALUE];
<a name="l00341"></a>00341         <span class="keywordtype">char</span> target_filename[FLEN_VALUE];
<a name="l00342"></a>00342         <span class="keywordtype">int</span> status = 0;
<a name="l00343"></a>00343         <span class="keywordtype">int</span> i, j, iwav;
<a name="l00344"></a>00344         <span class="keywordtype">double</span> nulval;
<a name="l00345"></a>00345         <span class="keywordtype">string</span> filename = <span class="stringliteral">&quot;!&quot;</span> + datafile;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         cout &lt;&lt; <span class="stringliteral">&quot;Generating OIFITS: &quot;</span> &lt;&lt; filename &lt;&lt; endl;
<a name="l00348"></a>00348         <span class="comment">// Set to strings</span>
<a name="l00349"></a>00349         strncpy(zerostring, <span class="stringliteral">&quot; &quot;</span>, FLEN_VALUE);
<a name="l00350"></a>00350         strncpy(insname, <span class="stringliteral">&quot;Fake_Ins&quot;</span>, FLEN_VALUE);
<a name="l00351"></a>00351         strncpy(arrname, <span class="stringliteral">&quot;Fake_Arr&quot;</span>, FLEN_VALUE);
<a name="l00352"></a>00352         strncpy(target_filename, <span class="stringliteral">&quot;Fake_Targ&quot;</span>, FLEN_VALUE);
<a name="l00353"></a>00353         <span class="comment">// FITS NULL</span>
<a name="l00354"></a>00354         nulval = 0.0;
<a name="l00355"></a>00355         nulval /= nulval;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="comment">// TARGETS</span>
<a name="l00358"></a>00358         <span class="comment">/*</span>
<a name="l00359"></a>00359 <span class="comment">         * use malloc as free_oi_target() uses free: </span>
<a name="l00360"></a>00360 <span class="comment">         */</span>
<a name="l00361"></a>00361         targets.targ = (target *) malloc(<span class="keyword">sizeof</span>(target));
<a name="l00362"></a>00362         targets.revision = 1;
<a name="l00363"></a>00363         targets.ntarget = 1;
<a name="l00364"></a>00364         targets.targ[0].target_id = 1;
<a name="l00365"></a>00365         strncpy(targets.targ[0].target, target_filename, 16);
<a name="l00366"></a>00366         targets.targ[0].raep0 = nulval;
<a name="l00367"></a>00367         targets.targ[0].decep0 = declination;
<a name="l00368"></a>00368         targets.targ[0].equinox = 2000.0;
<a name="l00369"></a>00369         targets.targ[0].ra_err = nulval;
<a name="l00370"></a>00370         targets.targ[0].dec_err = nulval;
<a name="l00371"></a>00371         targets.targ[0].sysvel = nulval;
<a name="l00372"></a>00372         strncpy(targets.targ[0].veltyp, zerostring, 8);
<a name="l00373"></a>00373         strncpy(targets.targ[0].veldef, zerostring, 8);
<a name="l00374"></a>00374         targets.targ[0].pmra = nulval;
<a name="l00375"></a>00375         targets.targ[0].pmdec = nulval;
<a name="l00376"></a>00376         targets.targ[0].pmra_err = nulval;
<a name="l00377"></a>00377         targets.targ[0].pmdec_err = nulval;
<a name="l00378"></a>00378         targets.targ[0].parallax = nulval;
<a name="l00379"></a>00379         targets.targ[0].para_err = nulval;
<a name="l00380"></a>00380         strncpy(targets.targ[0].spectyp, zerostring, 16);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="comment">// ARRAY</span>
<a name="l00383"></a>00383         <span class="comment">// AS 2010-06-17</span>
<a name="l00384"></a>00384         <span class="comment">// added the array table in the OIFITS file</span>
<a name="l00385"></a>00385         <span class="keywordtype">double</span> nstations = s.<a class="code" href="classArray.html#a1c745caf02f1a9177f870c493561d891">GetNumStations</a>();
<a name="l00386"></a>00386         <span class="keywordtype">double</span> longitude = s.<a class="code" href="classArray.html#ab3b8cb71d4721b6f5e50a1678eab0d98">GetLongitude</a>();
<a name="l00387"></a>00387         <span class="keywordtype">double</span> latitude = s.<a class="code" href="classArray.html#ab6dbcc092c509568a17875bcd9f89f2e">GetLatitude</a>();
<a name="l00388"></a>00388         <span class="keywordtype">double</span> altitude = s.<a class="code" href="classArray.html#af8085a1990cb03ec60310289758a7ad0">GetAltitude</a>();
<a name="l00389"></a>00389         <span class="keywordtype">string</span> arrayname = s.<a class="code" href="classArray.html#ad881590afefd938b89b5d078d43c2548">GetArrayName</a>();
<a name="l00390"></a>00390         
<a name="l00391"></a>00391         array.elem = (element *) malloc(nstations * <span class="keyword">sizeof</span>(element));
<a name="l00392"></a>00392         array.revision = 1;
<a name="l00393"></a>00393         strncpy(array.arrname, arrayname.c_str(), FLEN_VALUE);
<a name="l00394"></a>00394         strncpy(array.frame, <span class="stringliteral">&quot;GEOCENTRIC&quot;</span>, FLEN_VALUE);
<a name="l00395"></a>00395         <span class="keywordtype">double</span> GeocLat, GeocRadius;
<a name="l00396"></a>00396         <span class="comment">// AS 2010-06-22</span>
<a name="l00397"></a>00397         <span class="comment">// adapting the coordinates of the array using JSY&#39;s routine</span>
<a name="l00398"></a>00398         <span class="comment">// wgs84_to_geoc</span>
<a name="l00399"></a>00399         <a class="code" href="oifits__sim_8cpp.html#abc8d1aa870a53f018b7e1e79a7968041">wgs84_to_geoc</a>(latitude * <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a> / 180, altitude, &amp;GeocLat, &amp;GeocRadius);
<a name="l00400"></a>00400         array.arrayx = GeocRadius * cos(GeocLat) * cos(longitude * <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a> / 180);
<a name="l00401"></a>00401         array.arrayy = GeocRadius * cos(GeocLat) * sin(longitude * <a class="code" href="Simulator_8h.html#a952eac791b596a61bba0a133a3bb439f">PI</a> / 180);
<a name="l00402"></a>00402         array.arrayz = GeocRadius * sin(GeocLat);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         array.nelement = nstations;
<a name="l00405"></a>00405         <a class="code" href="classStation.html" title="A class to represent a station (i.e. telescope) in an.">Station</a> station;
<a name="l00406"></a>00406         <span class="keywordflow">for</span> (i = 0; i &lt; nstations; i++)
<a name="l00407"></a>00407         {
<a name="l00408"></a>00408             station = s.<a class="code" href="classArray.html#acb9ecf27c0fe2ad73e15c34f80d90c5c">GetStation</a>(i);
<a name="l00409"></a>00409                 strncpy(array.elem[i].tel_name, <span class="stringliteral">&quot;Fake Telescope&quot;</span>, 16);
<a name="l00410"></a>00410                 strncpy(array.elem[i].sta_name, station.<a class="code" href="classStation.html#aad118a81a8498e1196c85b7a16e3be91">GetName</a>().c_str(), 16);
<a name="l00412"></a>00412                 array.elem[i].sta_index = i + 1;
<a name="l00413"></a>00413                 array.elem[i].diameter = station.<a class="code" href="classStation.html#aa7b65ca1b24be6b9b071097d5581054c">diameter</a>;
<a name="l00414"></a>00414                 array.elem[i].staxyz[0] = station.<a class="code" href="classStation.html#af5b031756ab9e16e3f35bfd9ca0f0d70">xyz</a>[0];
<a name="l00415"></a>00415                 array.elem[i].staxyz[1] = station.<a class="code" href="classStation.html#af5b031756ab9e16e3f35bfd9ca0f0d70">xyz</a>[1];
<a name="l00416"></a>00416                 array.elem[i].staxyz[2] = station.<a class="code" href="classStation.html#af5b031756ab9e16e3f35bfd9ca0f0d70">xyz</a>[2];
<a name="l00417"></a>00417         }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="comment">// WAVE</span>
<a name="l00420"></a>00420         wave.nwave = spec.<a class="code" href="classSpectralMode.html#a7c68010a64d612a452df276003689eca">nchannels</a>;
<a name="l00421"></a>00421         wave.eff_wave = (<span class="keywordtype">float</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00422"></a>00422         wave.eff_band = (<span class="keywordtype">float</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00423"></a>00423         wave.revision = 1;
<a name="l00424"></a>00424         strncpy(wave.insname, insname, FLEN_VALUE);
<a name="l00425"></a>00425         <span class="keywordflow">for</span> (iwav = 0; iwav &lt; wave.nwave; iwav++)
<a name="l00426"></a>00426         {
<a name="l00427"></a>00427                 wave.eff_wave[iwav] = spec.<a class="code" href="classSpectralMode.html#af83f2181ef2b8660feac40e7691893d6">mean_wavelength</a>[iwav];
<a name="l00428"></a>00428                 wave.eff_band[iwav] = spec.<a class="code" href="classSpectralMode.html#af4835d0dd1c5276798e400f3bcfa1bb7">delta_wavelength</a>[iwav];
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <span class="comment">// VIS2</span>
<a name="l00432"></a>00432         vis2.record = (oi_vis2_record *) malloc(Npow * <span class="keyword">sizeof</span>(oi_vis2_record));
<a name="l00433"></a>00433         <span class="keywordflow">for</span> (j = 0; j &lt; Npow; j++)
<a name="l00434"></a>00434         {
<a name="l00435"></a>00435                 vis2.record[j].vis2data = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00436"></a>00436                 vis2.record[j].vis2err = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00437"></a>00437                 vis2.record[j].flag = (<span class="keywordtype">char</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439         vis2.revision = 1;
<a name="l00440"></a>00440         strncpy(vis2.date_obs, <span class="stringliteral">&quot;2009-08-06&quot;</span>, FLEN_VALUE);
<a name="l00441"></a>00441         strncpy(vis2.arrname, arrname, FLEN_VALUE);
<a name="l00442"></a>00442         strncpy(vis2.insname, insname, FLEN_VALUE);
<a name="l00443"></a>00443         vis2.numrec = Npow;
<a name="l00444"></a>00444         vis2.nwave = wave.nwave;
<a name="l00445"></a>00445         <span class="keywordflow">for</span> (j = 0; j &lt; Npow; j++)
<a name="l00446"></a>00446         {
<a name="l00447"></a>00447                 vis2.record[j].target_id = 1;
<a name="l00448"></a>00448                 vis2.record[j].time = time[j];
<a name="l00449"></a>00449                 vis2.record[j].mjd = 0.0;
<a name="l00450"></a>00450                 vis2.record[j].int_time = Power.<a class="code" href="classPowerSpectrum.html#a7d07ae6e17c08448bc5ae8a79fc36a95">int_time</a>;
<a name="l00451"></a>00451                 vis2.record[j].ucoord = Power.<a class="code" href="classPowerSpectrum.html#a42e71945396d45b5603b5ea1f4933a6a">u</a>[0][j];
<a name="l00452"></a>00452                 vis2.record[j].vcoord = Power.<a class="code" href="classPowerSpectrum.html#a48e7c06920fc8baaa690a7fcf71284d7">v</a>[0][j];
<a name="l00453"></a>00453                 vis2.record[j].sta_index[0] = Power.<a class="code" href="classPowerSpectrum.html#a63136c308d576020a0611fef55e7165b">t1</a>[0][j];
<a name="l00454"></a>00454                 vis2.record[j].sta_index[1] = Power.<a class="code" href="classPowerSpectrum.html#a449e5f435037ff6354d2decaa1345f81">t2</a>[0][j];
<a name="l00455"></a>00455                 <span class="keywordflow">for</span> (iwav = 0; iwav &lt; wave.nwave; iwav++)
<a name="l00456"></a>00456                 {
<a name="l00457"></a>00457                         vis2.record[j].vis2data[iwav] = Power.<a class="code" href="classPowerSpectrum.html#a98e7a9d427be82f83bc9e925d8a44d71">vis2data</a>[iwav][j];
<a name="l00458"></a>00458                         vis2.record[j].vis2err[iwav] = Power.<a class="code" href="classPowerSpectrum.html#a68e8c6a4fa15893a796f233e35b9886a">vis2err</a>[iwav][j];
<a name="l00459"></a>00459                         vis2.record[j].flag[iwav] = FALSE;
<a name="l00460"></a>00460                 }
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="comment">// T3</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (pBispec != NULL)
<a name="l00465"></a>00465         {
<a name="l00466"></a>00466                 t3.record = (oi_t3_record *) malloc(Nbs * <span class="keyword">sizeof</span>(oi_t3_record));
<a name="l00467"></a>00467                 <span class="keywordflow">for</span> (j = 0; j &lt; Nbs; j++)
<a name="l00468"></a>00468                 {
<a name="l00469"></a>00469                         t3.record[j].t3amp = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00470"></a>00470                         t3.record[j].t3amperr = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00471"></a>00471                         t3.record[j].t3phi = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00472"></a>00472                         t3.record[j].t3phierr = (<span class="keywordtype">double</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00473"></a>00473                         t3.record[j].flag = (<span class="keywordtype">char</span> *) malloc(wave.nwave * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00474"></a>00474                 }
<a name="l00475"></a>00475                 t3.revision = 1;
<a name="l00476"></a>00476                 strncpy(t3.date_obs, <span class="stringliteral">&quot;2009-04-15&quot;</span>, FLEN_VALUE);
<a name="l00477"></a>00477                 strncpy(t3.arrname, arrname, FLEN_VALUE);
<a name="l00478"></a>00478                 strncpy(t3.insname, insname, FLEN_VALUE);
<a name="l00479"></a>00479                 t3.numrec = Nbs;
<a name="l00480"></a>00480                 t3.nwave = wave.nwave;
<a name="l00481"></a>00481                 <span class="keywordflow">for</span> (j = 0; j &lt; Nbs; j++)
<a name="l00482"></a>00482                 {
<a name="l00483"></a>00483                         t3.record[j].target_id = 1;
<a name="l00484"></a>00484                         t3.record[j].time = time[j];
<a name="l00485"></a>00485                         t3.record[j].mjd = 0.0;
<a name="l00486"></a>00486                         t3.record[j].int_time = pBispec-&gt;<a class="code" href="classBispectrum.html#a1f82b8ea4518fa3870102b1975282c44">int_time</a>;
<a name="l00487"></a>00487                         t3.record[j].u1coord = pBispec-&gt;<a class="code" href="classBispectrum.html#a4aa12f9f42ec6a9a622eae258886a70a">u1</a>[0][j];
<a name="l00488"></a>00488                         t3.record[j].v1coord = pBispec-&gt;<a class="code" href="classBispectrum.html#aaaba6a43c24620293150b6c8b1e7e3cc">v1</a>[0][j];
<a name="l00489"></a>00489                         t3.record[j].u2coord = pBispec-&gt;<a class="code" href="classBispectrum.html#a1273b649ed0b0395095e46553abd4590">u2</a>[0][j];
<a name="l00490"></a>00490                         t3.record[j].v2coord = pBispec-&gt;<a class="code" href="classBispectrum.html#a3f96bf8f14f36a1b554f094e74eea14e">v2</a>[0][j];
<a name="l00491"></a>00491                         t3.record[j].sta_index[0] = pBispec-&gt;<a class="code" href="classBispectrum.html#acdc726e2151be0caed4263bfd5945d35">t1</a>[0][j];
<a name="l00492"></a>00492                         t3.record[j].sta_index[1] = pBispec-&gt;<a class="code" href="classBispectrum.html#a0fc19bc4234f4d5f5b5fff0f16a1d19a">t2</a>[0][j];
<a name="l00493"></a>00493                         t3.record[j].sta_index[2] = pBispec-&gt;<a class="code" href="classBispectrum.html#a35a0c8149a0543a004044ff4ffc2eea1">t3</a>[0][j];
<a name="l00494"></a>00494                         <span class="keywordflow">for</span> (iwav = 0; iwav &lt; wave.nwave; iwav++)
<a name="l00495"></a>00495                         {
<a name="l00496"></a>00496                                 t3.record[j].t3amp[iwav] = pBispec-&gt;<a class="code" href="classBispectrum.html#a4f353f039c28e9a954b35efeee88803a">t3amp</a>[iwav][j];
<a name="l00497"></a>00497                                 t3.record[j].t3phi[iwav] = pBispec-&gt;<a class="code" href="classBispectrum.html#afb0c6a5e00123a0816cdaf3f5cf99fb2">t3phi</a>[iwav][j];
<a name="l00498"></a>00498                                 t3.record[j].t3amperr[iwav] = pBispec-&gt;<a class="code" href="classBispectrum.html#acfb791e23ce2fe5a0d3207d600f5fced">t3amperr</a>[iwav][j];
<a name="l00499"></a>00499                                 t3.record[j].t3phierr[iwav] = pBispec-&gt;<a class="code" href="classBispectrum.html#acbda066ba007c56246f1a7dc0040e8a4">t3phierr</a>[iwav][j];
<a name="l00500"></a>00500                                 t3.record[j].flag[iwav] = FALSE;
<a name="l00501"></a>00501                         }
<a name="l00502"></a>00502                 }
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504         <span class="comment">// Write OI-FITS file</span>
<a name="l00505"></a>00505         fits_create_file(&amp;fptr, filename.c_str(), &amp;status);
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (status)
<a name="l00507"></a>00507         {
<a name="l00508"></a>00508                 fits_report_error(stderr, status);
<a name="l00509"></a>00509                 <span class="keywordflow">return</span>;
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         write_oi_array(fptr, array, 1, &amp;status);
<a name="l00513"></a>00513         write_oi_target(fptr, targets, &amp;status);
<a name="l00514"></a>00514         write_oi_vis2(fptr, vis2, 1, &amp;status);
<a name="l00515"></a>00515         <span class="keywordflow">if</span> (pBispec != NULL)
<a name="l00516"></a>00516         {
<a name="l00517"></a>00517                 write_oi_t3(fptr, t3, 1, &amp;status);
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         write_oi_wavelength(fptr, wave, 1, &amp;status);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (status)
<a name="l00522"></a>00522         {
<a name="l00523"></a>00523                 fits_delete_file(fptr, &amp;status);
<a name="l00524"></a>00524                 <span class="keywordflow">return</span>;
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526         <span class="keywordflow">else</span>
<a name="l00527"></a>00527         {
<a name="l00528"></a>00528                 fits_close_file(fptr, &amp;status);
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="comment">/*</span>
<a name="l00532"></a>00532 <span class="comment">         * Free OI-FITS data structure memory </span>
<a name="l00533"></a>00533 <span class="comment">         */</span>
<a name="l00534"></a>00534         free_oi_array(&amp;array);
<a name="l00535"></a>00535         free_oi_target(&amp;targets);
<a name="l00536"></a>00536         free_oi_wavelength(&amp;wave);
<a name="l00537"></a>00537         free_oi_vis2(&amp;vis2);
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (pBispec != NULL)
<a name="l00539"></a>00539         {
<a name="l00540"></a>00540                 free_oi_t3(&amp;t3);
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542         cout &lt;&lt; <span class="stringliteral">&quot;File written.\n&quot;</span>;
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="comment">// function that computes the visibilities</span>
<a name="l00546"></a>00546 <span class="comment">// as arguments: the wavelengths, the hour angles, the source, the array</span>
<a name="l00547"></a>00547 <span class="comment">// configuration, and the instrument</span>
<a name="l00548"></a>00548 <span class="comment">//void generate_oifits(SpectralMode &amp; spec, HourAngle &amp; ha, Source &amp; target, Array &amp; s, Instrument &amp; inst, string oifits_filename)</span>
<a name="l00549"></a>00549 <span class="comment">//{</span>
<a name="l00550"></a>00550 <span class="comment">//      int Npow;                                       // number of sampled hour angles</span>
<a name="l00551"></a>00551 <span class="comment">//      int Nbs;                                        // number of bispectra</span>
<a name="l00552"></a>00552 <span class="comment">//    int nstations = s.GetNumStations();</span>
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 <span class="comment">//      // number of columns in the power spectra matrix</span>
<a name="l00555"></a>00555 <span class="comment">//      Npow = ha.Nha * nstations * (nstations - 1) / 2;</span>
<a name="l00556"></a>00556 <span class="comment">//      // number of columns in the bispectrum matrix</span>
<a name="l00557"></a>00557 <span class="comment">//      Nbs = ha.Nha * (nstations - 1) * (nstations - 2) / 2;</span>
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 <span class="comment">//      // matrix recording the visibilities at each time step</span>
<a name="l00560"></a>00560 <span class="comment">//      Matrix &lt; Complex &gt; visibility(spec.nchannels, Npow);</span>
<a name="l00561"></a>00561 <span class="comment">//      // matrix recording the u coordinate</span>
<a name="l00562"></a>00562 <span class="comment">//      Matrix &lt; double &gt;u(spec.nchannels, Npow);</span>
<a name="l00563"></a>00563 <span class="comment">//      // matrix recording the v coordinate</span>
<a name="l00564"></a>00564 <span class="comment">//      Matrix &lt; double &gt;v(spec.nchannels, Npow);</span>
<a name="l00565"></a>00565 <span class="comment">//      // matrix recording the index of the 1st telescope</span>
<a name="l00566"></a>00566 <span class="comment">//      Matrix &lt; int &gt;t1(spec.nchannels, Npow);</span>
<a name="l00567"></a>00567 <span class="comment">//      // matrix recording the index of the 2nd telescope</span>
<a name="l00568"></a>00568 <span class="comment">//      Matrix &lt; int &gt;t2(spec.nchannels, Npow);</span>
<a name="l00569"></a>00569 <span class="comment">//      // row vector recording the hour angles</span>
<a name="l00570"></a>00570 <span class="comment">//      Row &lt; double &gt;time(Npow);</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 <span class="comment">//      int ii = 0;                                     // counter running through all the</span>
<a name="l00573"></a>00573 <span class="comment">//      // wavelengths</span>
<a name="l00574"></a>00574 <span class="comment">//      int jj = 0;                                     // counter running through all the HA</span>
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 <span class="comment">//      double wl = 0;                          // temporary variable storing the current</span>
<a name="l00577"></a>00577 <span class="comment">//      // wavelength</span>
<a name="l00578"></a>00578 <span class="comment">//      double wn = 0;                          // temporary variable storing the current</span>
<a name="l00579"></a>00579 <span class="comment">//      // wavenumber</span>
<a name="l00580"></a>00580 <span class="comment">//      double h = 0;                           // temporary variable storing the current</span>
<a name="l00581"></a>00581 <span class="comment">//      // hour angle</span>
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="comment">//      UVPoint uv;</span>
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 <span class="comment">//      cout &lt;&lt; &quot;Integration time = &quot; &lt;&lt; 1e3 * TimeInt(spec.median_wavelength,</span>
<a name="l00586"></a>00586 <span class="comment">//         inst.ast_seeing, inst.wind_speed) &lt;&lt; &quot;ms&quot; &lt;&lt; endl;</span>
<a name="l00587"></a>00587 <span class="comment">//      for (int l = 0; l &lt; spec.nchannels; l++)        // loop over the</span>
<a name="l00588"></a>00588 <span class="comment">//              // wavelengths</span>
<a name="l00589"></a>00589 <span class="comment">//      {</span>
<a name="l00590"></a>00590 <span class="comment">//              wl = spec.mean_wavelength[l];</span>
<a name="l00591"></a>00591 <span class="comment">//              wn = spec.mean_wavenumber[l];</span>
<a name="l00592"></a>00592 <span class="comment">//              jj = 0;</span>
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="comment">//              // print photon count for this spectral channel for user to check</span>
<a name="l00595"></a>00595 <span class="comment">//              double Ni = PhCount(target, s, inst, spec.median_wavelength, wl, spec.delta_wavelength[l]);</span>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">//              cout &lt;&lt; &quot;Channel &quot; &lt;&lt; l &lt;&lt; &quot;  Wavelength &quot; &lt;&lt; wl &lt;&lt;</span>
<a name="l00598"></a>00598 <span class="comment">//                 &quot; photons = &quot; &lt;&lt; Ni &lt;&lt; &quot;  (assumed Strehl &quot; &lt;&lt; Strehl(wl,</span>
<a name="l00599"></a>00599 <span class="comment">//                 inst.ast_seeing, s.diameter[0]) &lt;&lt; &quot;)&quot; &lt;&lt; endl;</span>
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 <span class="comment">//              // </span>
<a name="l00602"></a>00602 <span class="comment">//              double snr = pow(inst.visibility * Ni / nstations,</span>
<a name="l00603"></a>00603 <span class="comment">//                 2.0) / pow((pow(Ni, 2.0) + 2.0 * pow(Ni,</span>
<a name="l00604"></a>00604 <span class="comment">//                               3.0) * pow(inst.visibility,</span>
<a name="l00605"></a>00605 <span class="comment">//                               2.0) / pow(nstations,</span>
<a name="l00606"></a>00606 <span class="comment">//                               2.0) + 2.0 * pow(inst.Npix,</span>
<a name="l00607"></a>00607 <span class="comment">//                               2.0) * pow(inst.read_noise,</span>
<a name="l00608"></a>00608 <span class="comment">//                               4.0)), 0.5);</span>
<a name="l00609"></a>00609 <span class="comment">//              cout &lt;&lt; &quot;  point source unbiased V^2 SNR = &quot; &lt;&lt; snr &lt;&lt; endl;</span>
<a name="l00610"></a>00610 <span class="comment">//              // AS 2010-06-22</span>
<a name="l00611"></a>00611 <span class="comment">//              // modified the VarUnbiasedPow1 function by eliminating the</span>
<a name="l00612"></a>00612 <span class="comment">//              // incoherent integration time</span>
<a name="l00613"></a>00613 <span class="comment">//              cout &lt;&lt; &quot;  point source unbiased V^2 SNR = &quot; &lt;&lt;</span>
<a name="l00614"></a>00614 <span class="comment">//                 pow(VarUnbiasedPow1(1.0, spec, l, target, s, inst),</span>
<a name="l00615"></a>00615 <span class="comment">//                 -0.50) &lt;&lt; endl;</span>
<a name="l00616"></a>00616 <span class="comment">//              // AS 2010-06-22</span>
<a name="l00617"></a>00617 <span class="comment">//              // modified the VarPow1 function by eliminating the incoherent</span>
<a name="l00618"></a>00618 <span class="comment">//              // integration time</span>
<a name="l00619"></a>00619 <span class="comment">//              cout &lt;&lt; &quot;  point source biased   V^2 SNR = &quot; &lt;&lt;</span>
<a name="l00620"></a>00620 <span class="comment">//                 pow(VarPow1(1.0, spec, l, target, s, inst), -0.50) &lt;&lt; endl;</span>
<a name="l00621"></a>00621 <span class="comment">//              // </span>
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="comment">//              for (int k = 0; k &lt; ha.HA.size(); k++)  // for loop over all the</span>
<a name="l00624"></a>00624 <span class="comment">//                      // hour angles</span>
<a name="l00625"></a>00625 <span class="comment">//              {</span>
<a name="l00626"></a>00626 <span class="comment">//                      h = ha.HA[k];</span>
<a name="l00627"></a>00627 <span class="comment">//                      // for loop over the 1st telescope defining the baseline</span>
<a name="l00628"></a>00628 <span class="comment">//                      for (int i = 0; i &lt; (s.nstations - 1); i++)</span>
<a name="l00629"></a>00629 <span class="comment">//                      {</span>
<a name="l00630"></a>00630 <span class="comment">//                              // for loop over the 2nd telescope defining the baseline</span>
<a name="l00631"></a>00631 <span class="comment">//                              for (int j = i + 1; j &lt; s.nstations; j++)</span>
<a name="l00632"></a>00632 <span class="comment">//                              {</span>
<a name="l00633"></a>00633 <span class="comment">//                                      Baseline B(s, i, j);</span>
<a name="l00634"></a>00634 <span class="comment">//                                      uv = B.UVcoords(h, target.declination, wn);</span>
<a name="l00635"></a>00635 <span class="comment">//                                      visibility[ii][jj] = target.GetVis(uv);</span>
<a name="l00636"></a>00636 <span class="comment">//                                      u[ii][jj] = uv.u * wl;  // want u, v in meters</span>
<a name="l00637"></a>00637 <span class="comment">//                                      v[ii][jj] = uv.v * wl;</span>
<a name="l00638"></a>00638 <span class="comment">//                                      t1[ii][jj] = i;</span>
<a name="l00639"></a>00639 <span class="comment">//                                      t2[ii][jj] = j;</span>
<a name="l00640"></a>00640 <span class="comment">//                                      time[jj] = h;</span>
<a name="l00641"></a>00641 <span class="comment">//                                      jj++;           // counter running through all the columns</span>
<a name="l00642"></a>00642 <span class="comment">//                              }</span>
<a name="l00643"></a>00643 <span class="comment">//                      }</span>
<a name="l00644"></a>00644 <span class="comment">//              }</span>
<a name="l00645"></a>00645 <span class="comment">//              ii++;                                   // counter running through all the rows</span>
<a name="l00646"></a>00646 <span class="comment">//      }</span>
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">//      cout &lt;&lt; &quot;Npow is:&quot; &lt;&lt; Npow &lt;&lt; endl;</span>
<a name="l00649"></a>00649 <span class="comment">//      cout &lt;&lt; &quot;Nbs is:&quot; &lt;&lt; Nbs &lt;&lt; endl;</span>
<a name="l00650"></a>00650 <span class="comment">//      PowerSpectrum Power = GenPower(spec, visibility, target, s, inst, Npow, t1, t2, u, v);</span>
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 <span class="comment">//      // AS 2010-06-21</span>
<a name="l00653"></a>00653 <span class="comment">//      // fixed :Bug: segfault if Nbs zero</span>
<a name="l00654"></a>00654 <span class="comment">//      if (Nbs == 0)</span>
<a name="l00655"></a>00655 <span class="comment">//      {</span>
<a name="l00656"></a>00656 <span class="comment">//              cout &lt;&lt; &quot;Only 2 telescopes, no bispectra computed.&quot; &lt;&lt; endl;</span>
<a name="l00657"></a>00657 <span class="comment">//              write_oifits_file(target.declination, oifits_filename, s, spec,</span>
<a name="l00658"></a>00658 <span class="comment">//                 Power, Npow, NULL, Nbs, time);</span>
<a name="l00659"></a>00659 <span class="comment">//      }</span>
<a name="l00660"></a>00660 <span class="comment">//      else</span>
<a name="l00661"></a>00661 <span class="comment">//      {</span>
<a name="l00662"></a>00662 <span class="comment">//              Bispectrum Bispectrum =</span>
<a name="l00663"></a>00663 <span class="comment">//                 GenBispec(spec, visibility, target, s, inst,</span>
<a name="l00664"></a>00664 <span class="comment">//                 Nbs, ha.Nha, t1, t2, u, v);</span>
<a name="l00665"></a>00665 <span class="comment">//              write_oifits_file(target.declination, oifits_filename, s, spec,</span>
<a name="l00666"></a>00666 <span class="comment">//                 Power, Npow, &amp;Bispectrum, Nbs, time);</span>
<a name="l00667"></a>00667 <span class="comment">//      }</span>
<a name="l00668"></a>00668 <span class="comment">//}</span>
<a name="l00669"></a>00669 
<a name="l00670"></a><a class="code" href="oifits__sim_8h.html#a605cac6d1c5a57adc6806b0e3a6a4db7">00670</a> <span class="keywordtype">void</span> <a class="code" href="oifits__sim_8cpp.html#a605cac6d1c5a57adc6806b0e3a6a4db7">run_sim</a>(<span class="keyword">const</span> <a class="code" href="classVisSimParams.html">VisSimParams</a> * p)
<a name="l00671"></a>00671 {
<a name="l00674"></a>00674     <span class="keyword">const</span> <span class="keywordtype">string</span> comment_chars(<span class="stringliteral">&quot;\\#~$&amp;£%&quot;</span>);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="comment">// Now pull out the information that must be in a file:</span>
<a name="l00677"></a>00677     <span class="comment">// We use pointers in this function for consistency across all variables.</span>
<a name="l00678"></a>00678     <a class="code" href="classInstrument.html">Instrument</a> * inst = <span class="keyword">new</span> <a class="code" href="classInstrument.html">Instrument</a>(p-&gt;<a class="code" href="classVisSimParams.html#a1b39663100b7215fc5d8f61d30d85044">instrument_filename</a>, comment_chars);
<a name="l00679"></a>00679         <a class="code" href="classSpectralMode.html" title="A class to represent the spectral mode(s) of the instrument.">SpectralMode</a> * spec = <span class="keyword">new</span> <a class="code" href="classSpectralMode.html" title="A class to represent the spectral mode(s) of the instrument.">SpectralMode</a>(p-&gt;<a class="code" href="classVisSimParams.html#a5b4b6a34093cd8d538fa32e159477d8e">SpectralMode_filename</a>, comment_chars);
<a name="l00680"></a>00680         <a class="code" href="classSource.html" title="A class to represent the source object.">Source</a> * target = <span class="keyword">new</span> <a class="code" href="classSource.html" title="A class to represent the source object.">Source</a>(p-&gt;<a class="code" href="classVisSimParams.html#a225b522f1b7e0e07bb3745456693d84d">target_filename</a>, comment_chars);
<a name="l00681"></a>00681         
<a name="l00682"></a>00682         <span class="comment">// Allocate pointers for the array and hour angle information:</span>
<a name="l00683"></a>00683         <a class="code" href="classArray.html" title="A class to represent the array (i.e. the interferometer).">Array</a> * array = <span class="keyword">new</span> <a class="code" href="classArray.html" title="A class to represent the array (i.e. the interferometer).">Array</a>(p-&gt;<a class="code" href="classVisSimParams.html#ad4024dfafa47b1c4246c1885be3bd77e">array_filename</a>, comment_chars);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="comment">// Read in the observations.</span>
<a name="l00687"></a>00687 <span class="comment"></span>    vector&lt;Observation&gt; observations = <a class="code" href="classObservation.html#afa4f1d857808064ed86af14734382e96">Observation::ReadObservations</a>(array, p-&gt;<a class="code" href="classVisSimParams.html#af264c40e20632cfc50ebf48825cb5da8">observation_filename</a>, comment_chars, 1);
<a name="l00688"></a>00688         
<a name="l00689"></a>00689         
<a name="l00690"></a>00690 <span class="comment">//      // If we are using an OIFITS file as input, we need to call different constructors (hence the need for pointers here)</span>
<a name="l00691"></a>00691 <span class="comment">//      if(p-&gt;bFromOIFITSFile)</span>
<a name="l00692"></a>00692 <span class="comment">//    {</span>
<a name="l00693"></a>00693 <span class="comment">//        oi_fits input_oifits;</span>
<a name="l00694"></a>00694 <span class="comment">//        GList * entry;</span>
<a name="l00695"></a>00695 <span class="comment">//        oi_vis2 * pVis2 = NULL;</span>
<a name="l00696"></a>00696 <span class="comment">//        int status = 0;</span>
<a name="l00697"></a>00697 <span class="comment">//        list&lt;Observation&gt; observations;</span>
<a name="l00698"></a>00698 <span class="comment">//        </span>
<a name="l00699"></a>00699 <span class="comment">//        // Read in the OIFITS file using the library routine.</span>
<a name="l00700"></a>00700 <span class="comment">//        read_oi_fits(p-&gt;input_oifits_filename.c_str(), &amp;input_oifits, &amp;status);</span>
<a name="l00701"></a>00701 <span class="comment">//        </span>
<a name="l00702"></a>00702 <span class="comment">//        // Get some information about the data file</span>
<a name="l00703"></a>00703 <span class="comment">//        //print_oi_fits_summary(&amp;input_oifits);</span>
<a name="l00704"></a>00704 <span class="comment">//        </span>
<a name="l00705"></a>00705 <span class="comment">//        // Read out the UV coordinates:</span>
<a name="l00706"></a>00706 <span class="comment">//        // First iterate over the vis2 tables:</span>
<a name="l00707"></a>00707 <span class="comment">//        entry = g_list_first(input_oifits.vis2List);</span>
<a name="l00708"></a>00708 <span class="comment">//        while(entry)</span>
<a name="l00709"></a>00709 <span class="comment">//        {</span>
<a name="l00710"></a>00710 <span class="comment">//            pVis2 = (oi_vis2*) entry-&gt;data;</span>
<a name="l00711"></a>00711 <span class="comment">//            oi_vis2_record* records = pVis2-&gt;record;</span>
<a name="l00712"></a>00712 <span class="comment">//              </span>
<a name="l00713"></a>00713 <span class="comment">//            // Now iterate over the records in the table</span>
<a name="l00714"></a>00714 <span class="comment">//            for(int j = 0; j &lt; pVis2-&gt;numrec; j++)</span>
<a name="l00715"></a>00715 <span class="comment">//            {                                          </span>
<a name="l00716"></a>00716 <span class="comment">//                observations.push_back(Observation(records[j].mjd));</span>
<a name="l00717"></a>00717 <span class="comment">//            }</span>
<a name="l00718"></a>00718 <span class="comment">//            </span>
<a name="l00719"></a>00719 <span class="comment">//            entry = g_list_next(entry);</span>
<a name="l00720"></a>00720 <span class="comment">//        }</span>
<a name="l00721"></a>00721 <span class="comment">//        </span>
<a name="l00722"></a>00722 <span class="comment">//        // Now find the unique mjd,times in the data</span>
<a name="l00723"></a>00723 <span class="comment">//        //printf(&quot;List size: %i \n&quot;, observations.size());</span>
<a name="l00724"></a>00724 <span class="comment">//        observations.unique(SameObservation);</span>
<a name="l00725"></a>00725 <span class="comment">//        //printf(&quot;List size: %i \n&quot;, observations.size());</span>
<a name="l00726"></a>00726 <span class="comment">//        </span>
<a name="l00727"></a>00727 <span class="comment">//        // Now generate all list of hour angles from the specified observations:</span>
<a name="l00728"></a>00728 <span class="comment">//        ha = new HourAngle((*target), (*s), observations);</span>
<a name="l00729"></a>00729 <span class="comment">//        </span>
<a name="l00730"></a>00730 <span class="comment">//        // Now that we have what we need, free the memory used by the OIFITS file:</span>
<a name="l00731"></a>00731 <span class="comment">//        free_oi_fits(&amp;input_oifits);</span>
<a name="l00732"></a>00732 <span class="comment">//        </span>
<a name="l00733"></a>00733 <span class="comment">//        //exit(0);</span>
<a name="l00734"></a>00734 <span class="comment">//    }</span>
<a name="l00735"></a>00735 <span class="comment">//    else</span>
<a name="l00736"></a>00736 <span class="comment">//    {</span>
<a name="l00737"></a>00737 <span class="comment">//          // Now get the information that could come from an OIFITS file</span>
<a name="l00738"></a>00738 <span class="comment">//          ha = new HourAngle(p-&gt;HourAngles_filename.c_str());</span>
<a name="l00739"></a>00739 <span class="comment">//      }</span>
<a name="l00740"></a>00740 <span class="comment">//      </span>
<a name="l00741"></a>00741 <span class="comment">//      </span>
<a name="l00742"></a>00742 <span class="comment">//      // Now call the generator.  We de-reference the pointers here to avoid rewriting subsequent functions.</span>
<a name="l00743"></a>00743 <span class="comment">//    generate_oifits((*spec), (*ha), (*target), (*s), (*inst), p-&gt;oifits_filename);</span>
<a name="l00744"></a>00744     
<a name="l00745"></a>00745     <span class="comment">// Free up memory</span>
<a name="l00746"></a>00746     <span class="keyword">delete</span> inst;
<a name="l00747"></a>00747     <span class="keyword">delete</span> spec;
<a name="l00748"></a>00748     <span class="keyword">delete</span> target;
<a name="l00749"></a>00749     <span class="keyword">delete</span> array;
<a name="l00750"></a>00750 <span class="comment">//    delete ha;</span>
<a name="l00751"></a>00751 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Dec 9 00:22:58 2010 for OIFITS Simulator by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
